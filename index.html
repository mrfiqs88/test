<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Running Tracker</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa4b2;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; margin:0; background:linear-gradient(180deg,#071029 0%, #071422 100%); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px}
    .container{width:100%; max-width:980px}
    header{display:flex; align-items:center; gap:16px; margin-bottom:18px}
    .logo{width:56px;height:56px;background:linear-gradient(135deg,var(--accent),#7c3aed); border-radius:12px; display:grid; place-items:center; font-weight:700}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .grid{display:grid; grid-template-columns: 1fr 360px; gap:18px}

    .card{background:var(--card); border-radius:12px; padding:18px; box-shadow: 0 6px 24px rgba(2,6,23,0.6)}
    .controls{display:flex; gap:8px; margin-top:12px}
    button{background:var(--accent); border:0; color:#052026; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer}
    button.ghost{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.06)}
    button.warn{background:#fb7185; color:white}
    .big{font-size:28px; font-weight:700}
    .muted{color:var(--muted)}

    .metric-row{display:flex; gap:12px; margin-top:12px}
    .metric{flex:1; background:var(--glass); padding:12px; border-radius:10px; text-align:center}
    .metric .value{font-weight:700; font-size:18px}

    .history-table{width:100%; border-collapse:collapse; margin-top:12px}
    .history-table th, .history-table td{padding:8px 6px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.03); font-size:13px}

    footer.small{margin-top:8px;color:var(--muted); font-size:12px}

    @media (max-width:880px){.grid{grid-template-columns:1fr;}.card{padding:14px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">RT</div>
      <div>
        <h1>Running Tracker</h1>
        <p class="lead">Track runs with duration, steps, GPS distance (optional) and save history locally.</p>
      </div>
    </header>

    <div class="grid">
      <section class="card" id="tracker">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>
            <div class="big" id="timeDisplay">00:00:00</div>
            <div class="muted">Duration</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700; font-size:20px" id="distanceDisplay">0.000 km</div>
            <div class="muted">Distance</div>
          </div>
        </div>

        <div class="metric-row">
          <div class="metric">
            <div class="value" id="stepsDisplay">0</div>
            <div class="muted">Steps</div>
          </div>
          <div class="metric">
            <div class="value" id="speedDisplay">0.00 km/h</div>
            <div class="muted">Avg speed</div>
          </div>
        </div>

        <div class="controls">
          <button id="startBtn">Start Run</button>
          <button class="ghost" id="stepBtn">+ Step</button>
          <button class="ghost" id="pauseBtn">Pause</button>
          <button class="warn" id="stopBtn">Stop & Save</button>
        </div>

        <div style="margin-top:12px; color:var(--muted); font-size:13px">
          <strong>GPS:</strong> <span id="gpsStatus">Not tracking</span> — Allow location to measure distance accurately.
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="ghost" id="exportBtn">Export CSV</button>
          <button class="ghost" id="clearBtn">Clear History</button>
        </div>

        <footer class="small">Tip: On mobile, allow location and keep screen awake for GPS tracking.</footer>
      </section>

      <aside class="card">
        <h3 style="margin:0 0 10px 0">Run History</h3>
        <div style="max-height:460px; overflow:auto">
          <table class="history-table" id="historyTable">
            <thead>
              <tr><th>Date</th><th>Duration</th><th>Steps</th><th>Distance</th><th>Speed</th></tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
        <div id="noHistory" class="muted" style="margin-top:10px">No runs yet — start a run to save history.</div>
      </aside>
    </div>
  </div>

  <script>
    // --- Utilities ---
    function formatTimeSeconds(s){
      const hrs = Math.floor(s/3600); const mins = Math.floor((s%3600)/60); const secs = Math.floor(s%60);
      return `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    }

    function haversine(lat1, lon1, lat2, lon2){
      function toRad(x){return x*Math.PI/180}
      const R = 6371000; // meters
      const dLat = toRad(lat2-lat1); const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c; // meters
    }

    // --- State ---
    let running = false, paused = false;
    let startTimestamp = 0, elapsedBeforePause = 0;
    let timerInterval = null;
    let steps = 0;

    let tracking = false; // gps
    let watchId = null;
    let lastPos = null; // {lat, lon}
    let distanceMeters = 0;

    // Elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const stepBtn = document.getElementById('stepBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const timeDisplay = document.getElementById('timeDisplay');
    const stepsDisplay = document.getElementById('stepsDisplay');
    const distanceDisplay = document.getElementById('distanceDisplay');
    const speedDisplay = document.getElementById('speedDisplay');
    const gpsStatus = document.getElementById('gpsStatus');
    const historyBody = document.getElementById('historyBody');
    const noHistory = document.getElementById('noHistory');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');

    // --- Timer ---
    function startTimer(){
      startTimestamp = Date.now();
      timerInterval = setInterval(updateUI, 500);
    }
    function stopTimer(){
      clearInterval(timerInterval); timerInterval = null;
    }
    function getElapsedSeconds(){
      if(!running) return elapsedBeforePause;
      return (Date.now() - startTimestamp)/1000 + elapsedBeforePause;
    }

    // --- GPS ---
    function startGPS(){
      if(!('geolocation' in navigator)){
        gpsStatus.textContent = 'Geolocation not available';
        return;
      }
      gpsStatus.textContent = 'Requesting permission...';
      watchId = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        gpsStatus.textContent = `Tracking (accuracy ${Math.round(pos.coords.accuracy)} m)`;
        if(lastPos){
          const d = haversine(lastPos.lat, lastPos.lon, lat, lon);
          // ignore huge spikes
          if(d < 100){ distanceMeters += d; }
        }
        lastPos = {lat, lon};
        tracking = true;
      }, err => {
        gpsStatus.textContent = 'Permission denied or unavailable';
        tracking = false;
      }, {enableHighAccuracy:true, maximumAge:1000, timeout:5000});
    }
    function stopGPS(){ if(watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; } tracking = false; lastPos = null; gpsStatus.textContent = 'Not tracking'; }

    // --- Storage ---
    function loadHistory(){
      const raw = localStorage.getItem('runs') || '[]';
      return JSON.parse(raw);
    }
    function saveHistory(arr){ localStorage.setItem('runs', JSON.stringify(arr)); }

    function addRunRecord(record){
      const h = loadHistory(); h.unshift(record); saveHistory(h); renderHistory(); }

    function renderHistory(){
      const h = loadHistory(); historyBody.innerHTML = '';
      if(h.length === 0){ noHistory.style.display = 'block'; return; } else { noHistory.style.display = 'none' }
      for(const r of h){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date}</td><td>${r.duration}</td><td>${r.steps}</td><td>${r.distance}</td><td>${r.speed}</td>`;
        historyBody.appendChild(tr);
      }
    }

    // --- UI updates ---
    function updateUI(){
      const elapsed = getElapsedSeconds();
      timeDisplay.textContent = formatTimeSeconds(elapsed);
      stepsDisplay.textContent = steps;
      const km = (distanceMeters/1000) + (steps * 0.78 / 1000); // combine GPS distance + estimated stride distance
      distanceDisplay.textContent = `${km.toFixed(3)} km`;
      const speed = (km / (elapsed/3600 || 1));
      speedDisplay.textContent = `${(isFinite(speed) ? speed : 0).toFixed(2)} km/h`;
    }

    // --- Controls ---
    startBtn.addEventListener('click', ()=>{
      if(running){ // already running -> do nothing
        return;
      }
      // reset
      steps = 0; distanceMeters = 0; elapsedBeforePause = 0; lastPos = null;
      running = true; paused = false;
      startTimer();
      updateUI();
      startGPS();
      startBtn.disabled = true; pauseBtn.disabled = false; stopBtn.disabled = false; stepBtn.disabled = false;
    });

    pauseBtn.addEventListener('click', ()=>{
      if(!running) return;
      if(!paused){
        // pause
        elapsedBeforePause = getElapsedSeconds(); stopTimer(); stopGPS(); paused = true; pauseBtn.textContent = 'Resume'; gpsStatus.textContent = 'Paused';
      } else {
        // resume
        paused = false; startTimestamp = Date.now(); startTimer(); startGPS(); pauseBtn.textContent = 'Pause';
      }
    });

    stepBtn.addEventListener('click', ()=>{ steps += 1; updateUI(); });

    stopBtn.addEventListener('click', ()=>{
      if(!running) return;
      const elapsed = getElapsedSeconds(); stopTimer(); stopGPS(); running = false; startBtn.disabled = false; pauseBtn.disabled = true; stopBtn.disabled = true; stepBtn.disabled = true;
      // compute final metrics
      const km = (distanceMeters/1000) + (steps * 0.78 / 1000);
      const durationStr = formatTimeSeconds(elapsed);
      const speed = (km / (elapsed/3600 || 1));
      const record = { date: new Date().toLocaleString(), duration: durationStr, steps: steps, distance: `${km.toFixed(3)} km`, speed: `${speed.toFixed(2)} km/h` };
      addRunRecord(record);
      // reset displays where appropriate
      updateUI();
      alert('Run saved to history');
    });

    exportBtn.addEventListener('click', ()=>{
      const h = loadHistory(); if(h.length===0){ alert('No runs to export'); return; }
      const rows = [['date','duration','steps','distance_km','avg_speed_kmh']];
      for(const r of h){
        // parse distance and speed
        const d = r.distance.replace(' km','');
        const s = r.speed.replace(' km/h','');
        rows.push([r.date, r.duration, r.steps, d, s]);
      }
      const csv = rows.map(r => r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'runs.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    clearBtn.addEventListener('click', ()=>{
      if(confirm('Clear all run history? This cannot be undone.')){ localStorage.removeItem('runs'); renderHistory(); }
    });

    // Init
    renderHistory();
    pauseBtn.disabled = true; stopBtn.disabled = true; stepBtn.disabled = true;
  </script>
</body>
</html>
